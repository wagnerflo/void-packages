# Template file for 'mongodb'
pkgname=mongodb
version=7.0.7
revision=1
archs="x86_64"
hostmakedepends="pkg-config python3-cheetah3 python3-packaging
 python3-psutil python3-pymongo python3-setuptools python3-yaml"
makedepends="boost-devel libbson-devel liblzma-devel libstemmer-devel
 libunwind-devel libzstd-devel mongo-c-driver-devel openssl-devel
 pcre2-devel snappy-devel yaml-cpp-devel zlib-devel"
short_desc="Distributed document-oriented NoSQL database"
maintainer="Florian Wagner <florian@wagner-flo.de>"
license="custom:Proprietary"
homepage="https://www.mongodb.com"
distfiles="https://fastdl.mongodb.org/src/mongodb-src-r${version}.tar.gz"
checksum=a2dce499bf32271baca14f430e3f57360d2ac70248a473ff1d2f381883ac2696
restricted=yes

system_accounts="_mongodb"
mongodb_homedir="/var/lib/mongodb"
make_dirs="/var/lib/mongodb 0750 _mongodb _mongodb"
conf_files="/etc/mongodb.conf"

post_patch() {
	rm -rf src/third_party/boost
	rm -rf src/third_party/libbson
	rm -rf src/third_party/pcre2
	rm -rf src/third_party/snappy-*
	rm -rf src/third_party/libstemmer_c
	rm -rf src/third_party/unwind
	rm -rf src/third_party/yaml-cpp
	rm -rf src/third_party/zlib*
	rm -rf src/third_party/zstandard
}

do_build() {
	buildscripts/scons.py \
		 --allocator=system \
		 --cxx-std=20 \
		 --disable-warnings-as-errors \
		 --runtime-hardening=on \
		 --use-system-libunwind \
		 --use-system-pcre2 \
		 --use-system-snappy \
		 --use-system-stemmer \
		 --use-system-yaml \
		 --use-system-zlib \
		 --use-system-zstd \
		 --use-system-libbson \
		 --use-system-boost \
		 --use-system-mongo-c=on \
		 --ssl \
		 --modules= \
		 --linker=gold \
		 MONGO_VERSION=${version} \
		 VERBOSE=on
}

do_install() {
	vbin build/install/bin/mongod
	vbin build/install/bin/mongod
	vconf ${FILESDIR}/mongodb.conf
	vsv mongodb
	vlicense LICENSE-Community.txt
}
